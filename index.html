<!DOCTYPE html>
<html lang="zh-CN">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4227ae2c511d2f6bc7a9444bffb1154b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>911Design</title>
    <style>
        body { font-family: '微软雅黑'; max-width: 1000px; margin: 20px auto; padding: 20px; }
        .container { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .file-drop { height: 200px; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 20px; }
        #result { margin-top: 20px; line-height: 1.6; }
        .loading { display: none; color: #666; }
        .error { color: red; }
        .photo-list { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;}
        .photo-item { width: calc(33.333% - 10px); box-sizing: border-box;}
        .photo-thumbnail { width: 100%; height: auto; border-radius: 4px;}
        .photo-info { font-size: 12px;}
        .photo-map-container { width: 100%; height: 200px; margin-top: 8px; border-radius: 4px; border: 1px solid #e0e0e0;}
        #map-container { width:100%; height:400px;}
        .amap-btn { margin-top: 6px; display: inline-block; background: #409eff; color: #fff; border: none; border-radius: 3px; padding: 8px 12px; cursor: pointer; font-size: 13px;}
        .amap-btn:hover { background: #1976d2; }
        .photo-item { position: relative; }
        footer { text-align: center; margin: 20px 0; color: #666; font-size: 14px; }
    #exportCsvBtn{ display:none; position:fixed; right:24px; top:24px; z-index:9999; width:88px; height:88px; border-radius:50%; border:2px solid rgba(0,0,0,0.08); background:linear-gradient(135deg,#fff 0%,#f7f9fc 100%); box-shadow:0 6px 18px rgba(11,22,62,0.12); cursor:pointer; display:flex; align-items:center; justify-content:center; flex-direction:column; font-family: '微软雅黑'; }
    #photoInput{ display:none; }
        #exportCsvBtn svg{ display:block; }
        #exportCsvBtn span{ position:relative; top:-6px; font-size:12px; color:#1976d2; }
        #exportCsvBtn:hover{ transform:translateY(-2px); transition:transform 150ms ease; }
        #safeUseWrap{ position:fixed; left:24px; top:24px; z-index:10000; }
        #safeUseBtn{ width:72px; height:72px; border-radius:50%; border:2px solid rgba(0,0,0,0.06); background:linear-gradient(135deg,#fff 0%,#f3f7fb 100%); box-shadow:0 6px 18px rgba(11,22,62,0.08); display:flex; align-items:center; justify-content:center; flex-direction:column; cursor:pointer; font-family:'微软雅黑'; }
        #safeUseBtn div{ position:relative; top:-8px; font-size:12px; color:#00a86b; }
        #safeUsePanel{ display:none; margin-top:8px; width:320px; background:#fff; border-radius:8px; box-shadow:0 8px 28px rgba(11,22,62,0.12); padding:14px; font-size:13px; color:#333; }
        #safeUsePanel h4{ margin:0 0 8px 0; color:#0b3f2e; }
        #safeUsePanel p{ margin:0 0 8px 0; font-size:13px; color:#444; }
        #safeUsePanel ul, #safeUsePanel ol{ margin:0 0 8px 18px; padding:0; color:#444; }
        #safeUsePanel .actions{ margin-top:10px; display:flex; gap:8px; justify-content:flex-end; }
        #safeUseClose{ background:#f3f3f3; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
        #safeUseMore{ background:#00a86b; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    #shareBtn{ display:none; position:fixed; right:24px; top:124px; z-index:9999; width:88px; height:88px; border-radius:50%; border:2px solid rgba(0,0,0,0.08); background:linear-gradient(135deg,#fff 0%,#f7f9fc 100%); box-shadow:0 6px 18px rgba(11,22,62,0.12); cursor:pointer; display:flex; align-items:center; justify-content:center; flex-direction:column; font-family: '微软雅黑'; }
    #shareBtn:hover{ transform:translateY(-2px); transition:transform 150ms ease; }
    #shareBtn svg{ display:block; }
    #shareBtn span{ position:relative; top:-6px; font-size:12px; color:#1976d2; }
    /* 分享提示 */
    .share-notice{ position:fixed; right:24px; top:220px; z-index:10001; background:rgba(0,0,0,0.7); color:#fff; padding:8px 12px; border-radius:6px; font-size:13px; display:none; }
    </style>
</head>
<body>
    <div id="safeUseWrap">
        <button id="safeUseBtn" title="放心用" aria-expanded="false" aria-controls="safeUsePanel">
            <svg width="46" height="46" viewBox="0 0 46 46" xmlns="http://www.w3.org/2000/svg">
                <circle cx="23" cy="23" r="21" stroke="#00a86b" stroke-width="2" fill="none" stroke-opacity="0.14" />
                <path d="M14 23c2 4 6 8 15 4" stroke="#00a86b" stroke-width="2" stroke-linecap="round" fill="none"/>
            </svg>
            <div>放心用</div>
        </button>
        <div id="safeUsePanel" role="region" aria-hidden="true">
            <h4>放心使用 — 隐私与技术说明</h4>
            <p>我们理解您的隐私关切。请放心：</p>
            <ul>
                <li>照片仅在您的浏览器本地读取与解析，原始图片文件不会自动上传到我们的服务器。</li>
                <li>仅对经纬度坐标调用高德逆地理接口以获取位置描述；调用时只发送经纬度，不发送原图或其他个人信息。</li>
                <li>解析得到的数据（坐标、时间、设备型号等）默认仅保存在浏览器会话内，页面刷新后会清空，不会主动持久化到服务器。</li>
                <li>如果您选择导出（CSV）或手动上传数据，才会在您的操作下生成或传输数据；服务端不会在未授权下保存您的原始照片。</li>
            </ul>
            <p>技术细节：</p>
            <ol>
                <li>使用 <strong>exif-js</strong> 于浏览器端读取照片 EXIF，不上传原始图片。</li>
                <li>坐标转换（WGS84 → GCJ02）在客户端完成，随后仅用 GCJ02 坐标调用高德逆地理服务。</li>
                <li>CSV 导出在浏览器端生成并触发下载（UTF-8 BOM），不会自动发送到任何第三方。</li>
                <li>您可以关闭页面或清除缓存以清理会话数据；我们不在未授权情况下进行长期存储。</li>
            </ol>
            <div class="actions">
                <button id="safeUseClose">关闭</button>
                <button id="safeUseMore">查看更多</button>
            </div>
        </div>
    </div>
    <div class="container">
        <h2>多照片地理位置提取工具</h2>
        <div class="file-drop" id="fileDrop">
            <input type="file" accept="image/*" id="photoInput" multiple>
            <p>点击或拖拽上传多张照片（需包含GPS信息）</p>
        </div>
        <div class="photo-list" id="photoList"></div>
        <div class="loading">正在处理...请稍候</div>
        <div id="result"></div>
        <div id="map-container"></div>
    </div>

    <button id="exportCsvBtn" title="导出数据" aria-label="导出数据">
        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="28" cy="28" r="26" stroke="#1976d2" stroke-width="2" stroke-opacity="0.14" />
            <path d="M28 16V34" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 24L28 16L36 24" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>导出数据</span>
    </button>

    <button id="shareBtn" title="分享" aria-label="分享页面链接">
        <svg width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="28" cy="28" r="26" stroke="#1976d2" stroke-width="2" stroke-opacity="0.14" />
            <path d="M20 32L36 20" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 20H36V36" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>分享</span>
    </button>
    <div id="shareNotice" class="share-notice" role="status" aria-live="polite">链接已复制到剪贴板</div>

    <script src="https://webapi.amap.com/maps?v=2.0&key=6721a02023416bb36161a2eaa735b85a"></script>

    <script>
    function ensureExif() {
        return new Promise((resolve, reject) => {
            if (window.EXIF) return resolve();
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js';
            s.onload = () => resolve();
            s.onerror = () => reject(new Error('无法加载 EXIF 库'));
            document.head.appendChild(s);
        });
    }
    const redStarIcon = 'data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><polygon points="16,3 20,13 31,13 22,19 25,29 16,23 7,29 10,19 1,13 12,13" fill="red" stroke="black" stroke-width="1"/></svg>';

    const fileDrop = document.getElementById('fileDrop');
    const photoInput = document.getElementById('photoInput');
    const photoList = document.getElementById('photoList');
    const resultDiv = document.getElementById('result');
    const loadingDiv = document.querySelector('.loading');
    let map = null;
    let markers = [];
    let photosData = [];

    fileDrop.addEventListener('click', () => {
        photoInput.value = '';
        photoInput.click();
    });

    photoInput.addEventListener('change', handlePhotoUpload);

    fileDrop.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileDrop.style.borderColor = '#666';
        fileDrop.style.backgroundColor = '#f9f9f9';
    });
    fileDrop.addEventListener('dragleave', () => {
        fileDrop.style.borderColor = '#ccc';
        fileDrop.style.backgroundColor = '';
    });
    fileDrop.addEventListener('drop', (e) => {
        e.preventDefault();
        fileDrop.style.borderColor = '#ccc';
        fileDrop.style.backgroundColor = '';
        if (e.dataTransfer.files.length > 0) {
            handlePhotoUpload({ target: { files: e.dataTransfer.files } });
        }
    });

    async function handlePhotoUpload(e) {
        try {
            await ensureExif();
        } catch (err) {
            loadingDiv.style.display = 'none';
            resultDiv.classList.add('error');
            resultDiv.textContent = '无法加载 EXIF 库：' + err.message + '，请检查网络或改为离线引入 exif-js。';
            return;
        }
        const files = e.target.files;
        if (!files || files.length === 0) return;
        loadingDiv.style.display = 'block';
        resultDiv.innerHTML = '';
        photoList.innerHTML = '';
        photosData = [];
        clearMarkers();
        await initMap();

        let successCount = 0;
        for (let i = 0; i < files.length; i++) {
            try {
                await processPhoto(files[i], i + 1, files.length);
                successCount++;
            } catch (err) {
                createErrorThumbnailPreview(files[i], i + 1, err.message);
            }
        }
        if (successCount === 0) {
            resultDiv.classList.add('error');
            resultDiv.textContent = "所有照片均无有效GPS信息";
        } else {
            showSummaryResult();
            fitMapBounds();
        }
        try{ updateExportButtonState(); }catch(e){}
        loadingDiv.style.display = 'none';
    }

    async function processPhoto(file, index, totalCount) {
        return new Promise((resolve, reject) => {
            if (typeof EXIF === 'undefined') {
                reject(new Error('EXIF is not defined'));
                return;
            }
            EXIF.getData(file, function () {
                const exifData = EXIF.getAllTags(this);
                if (!exifData.GPSLatitude || !exifData.GPSLongitude) {
                    const err = new Error("不含GPS定位信息");
                    err.exif = {
                        GPSLatitude: exifData.GPSLatitude,
                        GPSLatitudeRef: exifData.GPSLatitudeRef,
                        GPSLongitude: exifData.GPSLongitude,
                        GPSLongitudeRef: exifData.GPSLongitudeRef
                    };
                    console.warn('EXIF GPS fields:', err.exif, 'full EXIF:', exifData);
                    reject(err);
                    return;
                }
                const gps = parseGPS(exifData);
                if (typeof gps.lng !== 'number' || typeof gps.lat !== 'number' || isNaN(gps.lng) || isNaN(gps.lat)) {
                    const err = new Error("无法解析GPS坐标");
                    err.exif = {
                        GPSLatitude: exifData.GPSLatitude,
                        GPSLatitudeRef: exifData.GPSLatitudeRef,
                        GPSLongitude: exifData.GPSLongitude,
                        GPSLongitudeRef: exifData.GPSLongitudeRef
                    };
                    console.warn('Parsed GPS is invalid:', gps, 'EXIF snippet:', err.exif, 'full EXIF:', exifData);
                    reject(err);
                    return;
                }
                const [gcjLng, gcjLat] = wgs84togcj02(gps.lng, gps.lat);
                createThumbnailPreview(file, index, gcjLng, gcjLat, exifData, "正在获取...");
                photosData.push({
                    index,
                    name: file.name,
                    url: URL.createObjectURL(file),
                    gpsWGS84: { lng: gps.lng, lat: gps.lat },
                    gpsGCJ02: { lng: gcjLng, lat: gcjLat },
                    exifData,
                    address: "",
                    file
                });
                addMarkerToMap(index, gcjLng, gcjLat, file.name, "正在获取...");
                getAddressFromAmap(gcjLng, gcjLat).then(addrObj => {
                    const addrStr = (addrObj && addrObj.formatted) ? addrObj.formatted : '未找到地址';
                    updateMarkerInfo(index - 1, addrStr);
                    photosData[index - 1].address = addrObj;
                    updateThumbnailAddress(index - 1, addrObj);
                    updatePhotoMap(index, gcjLng, gcjLat, file.name, addrObj);
                    resolve();
                }).catch(() => {
                    updateMarkerInfo(index - 1, "地址获取失败");
                    const failObj = { formatted: '地址获取失败', poi: '', components: null };
                    photosData[index - 1].address = failObj;
                    updateThumbnailAddress(index - 1, failObj);
                    updatePhotoMap(index, gcjLng, gcjLat, file.name, failObj);
                    resolve();
                });
            });
        });
    }

    function createThumbnailPreview(file, index, lng, lat, exifData, address) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const item = document.createElement('div');
            item.className = 'photo-item';
            let addressText = '';
            if (typeof address === 'string') addressText = address;
            else if (address && address.formatted) addressText = address.poi ? `${address.poi} (${address.formatted})` : address.formatted;
            else addressText = '' + address;
            const device = exifData && (exifData.Make || exifData.Model) ? `${exifData.Make || ''} ${exifData.Model || ''}`.trim() : '未知';
            const shotTime = getDateTimeFromExif(exifData);
            function fmt(v){ return (typeof v === 'number') ? v.toFixed(8) : v; }
            const fullGcjLng = (photosData && photosData[index-1] && photosData[index-1].gpsGCJ02) ? photosData[index-1].gpsGCJ02.lng : lng;
            const fullGcjLat = (photosData && photosData[index-1] && photosData[index-1].gpsGCJ02) ? photosData[index-1].gpsGCJ02.lat : lat;
            item.innerHTML = `
                <img src="${e.target.result}" class="photo-thumbnail">
                <p class="photo-info" id="photo-info-${index}">
                    ${index}. ${file.name}<br/>
                    拍摄设备：${device}<br/>
                    拍摄时间：${shotTime}<br/>
                    经度：<span title="${fullGcjLng}">${fmt(fullGcjLng)}</span><br/>
                    纬度：<span title="${fullGcjLat}">${fmt(fullGcjLat)}</span><br/>
                    拍摄地点：${addressText}
                </p>
                <div id="photo-map-${index}" class="photo-map-container"></div>
                <button class="amap-btn" onclick="openInAmapSingle(${index-1})">在高德地图中打开</button>
                <button class="amap-btn" onclick="copyCoords(${index-1})">复制坐标</button>
            `;
            photoList.appendChild(item);
            setTimeout(() => {
                updatePhotoMap(index, lng, lat, file.name, address);
            }, 0);
        };
        reader.readAsDataURL(file);
    }

    function updateThumbnailAddress(index, address) {
        const info = document.getElementById('photo-info-' + (index + 1));
        if (!info) return;
        let addressText = '';
        if (typeof address === 'string') addressText = address;
        else if (address && address.formatted) addressText = address.poi ? `${address.poi} (${address.formatted})` : address.formatted;
        else addressText = '' + address;
        if (/拍摄地点：/.test(info.innerHTML)) {
            info.innerHTML = info.innerHTML.replace(/拍摄地点：.*$/s, `拍摄地点：${addressText}`);
        } else {
            info.innerHTML += `<br/>拍摄地点：${addressText}`;
        }
    }

    function createErrorThumbnailPreview(file, index, errorMsg) {
        const reader = new FileReader();
        reader.onload = (e) => {
            let device = '未知';
            let shotTime = '未知';
            let exifSnippet = null;
            if (window.EXIF) {
                try {
                    EXIF.getData(file, function() {
                        const ex = EXIF.getAllTags(this) || {};
                        device = (ex.Make || ex.Model) ? `${ex.Make || ''} ${ex.Model || ''}`.trim() : device;
                        shotTime = getDateTimeFromExif(ex);
                        exifSnippet = {
                            GPSLatitude: ex.GPSLatitude,
                            GPSLatitudeRef: ex.GPSLatitudeRef,
                            GPSLongitude: ex.GPSLongitude,
                            GPSLongitudeRef: ex.GPSLongitudeRef
                        };
                        console.warn('Error parsing photo EXIF:', exifSnippet, ex);
                    });
                } catch (err) {
                }
            }
            const item = document.createElement('div');
            item.className = 'photo-item';
            const errDisplay = exifSnippet ? (`<br/>EXIF(GPS): ${JSON.stringify(exifSnippet)}`) : '';
            item.innerHTML = `
                <img src="${e.target.result}" class="photo-thumbnail">
                <p class="photo-info" style="color:#f00;" id="photo-info-${index}">
                    ${index}. ${file.name}<br/>
                    拍摄设备：${device}<br/>
                    拍摄时间：${shotTime}<br/>
                    错误：${errorMsg}${errDisplay}
                </p>`;
            photoList.appendChild(item);
        };
        reader.readAsDataURL(file);
    }

    function showSummaryResult() {
        let html = `<h3>处理完成</h3><p>成功解析 ${photosData.length} 张照片的GPS信息。</p><hr/>`;
        photosData.forEach((data, idx) => {
            html += `
                <details style="margin-bottom:10px;">
                    <summary><strong>${data.index}. ${data.name}</strong></summary>
                    <ul style="padding-left:15px;">
                        <li><strong>原始坐标(WGS84)</strong>: <span title="${data.gpsWGS84.lat},${data.gpsWGS84.lng}">${data.gpsWGS84.lat.toFixed(8)}, ${data.gpsWGS84.lng.toFixed(8)}</span> <button class="amap-btn" onclick="copyCoords(${idx})">复制坐标</button></li>
                        <li><strong>转换坐标(GCJ02)</strong>: <span title="${data.gpsGCJ02.lat},${data.gpsGCJ02.lng}">${data.gpsGCJ02.lat.toFixed(8)}, ${data.gpsGCJ02.lng.toFixed(8)}</span></li>
                        <li><strong>拍摄时间</strong>: ${getDateTimeFromExif(data.exifData)}</li>
                        <li><strong>拍摄设备</strong>: ${data.exifData && (data.exifData.Make || data.exifData.Model) ? `${data.exifData.Make || ''} ${data.exifData.Model || ''}` : '未知'}</li>
                        <li><strong>拍摄地点</strong>:<br/>${(data.address && data.address.formatted) ? (data.address.poi ? (data.address.poi + '<br/>' + data.address.formatted) : data.address.formatted) : (data.address || '未获取')}</li>
                        <li><button class="amap-btn" onclick="openInAmapSingle(${idx})">在高德地图中打开</button></li>
                    </ul>
                </details>
            `;
        });
        html += `<hr/><button class="amap-btn" onclick="openAllInAmap()">在高德地图中查看全部位置</button>`;
        resultDiv.innerHTML = html;
    }

    async function initMap() {
        if (map) return;
        map = new AMap.Map('map-container', {
            zoom: 13,
            viewMode: '3D'
        });
    }

    function addMarkerToMap(index, lng, lat, title, content) {
        if (!map) return;
        const marker = new AMap.Marker({
            position: [lng, lat],
            title: `${index}. ${title}`,
            icon: new AMap.Icon({
                image: redStarIcon,
                size: new AMap.Size(32, 32),
                imageSize: new AMap.Size(32, 32)
            }),
            offset: new AMap.Pixel(-16, -32)
        });
        marker.setMap(map);
        markers.push(marker);
    }

    function updateMarkerInfo(index, address) {
        if (!markers[index]) return;
        markers[index].setTitle(`${photosData[index].index}. ${photosData[index].name}\n${address}`);
    }

    function fitMapBounds() {
        if (!map || markers.length === 0) return;
        map.setFitView(markers);
        if (markers.length === 1) {
            map.setZoom(15);
        }
    }

    function clearMarkers() {
        if (!map) return;
        markers.forEach(m => m.setMap(null));
        markers = [];
    }

    function getDateTimeFromExif(exifData) {
        if (!exifData || !exifData.DateTimeOriginal) return '未知';
        const dtStr = String(exifData.DateTimeOriginal);
        if (/^\d{4}:\d{2}:\d{2}\s\d{2}:\d{2}:\d{2}$/.test(dtStr)) {
            const [datePart, timePart] = dtStr.split(' ');
            const [year, month, day] = datePart.split(':');
            const date = new Date(`${year}-${month}-${day}T${timePart}`);
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 ${timePart}`;
        } else {
            return dtStr;
        }
    }

    function parseGPS(exifData) {
        function toNumber(v) {
            if (v && typeof v === 'object') {
                if ('numerator' in v && 'denominator' in v) {
                    return v.denominator ? (v.numerator / v.denominator) : 0;
                }
                if (Array.isArray(v) && v.length >= 2) {
                    return v[1] ? (v[0] / v[1]) : v[0];
                }
            }
            if (typeof v === 'string') {
                const parts = v.split('/');
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    return Number(parts[0]) / Number(parts[1]);
                }
                const n = Number(v);
                return isNaN(n) ? null : n;
            }
            // number
            if (typeof v === 'number') return v;
            return null;
        }

        function dmsToDeg(dms, ref) {
            if (!dms || !dms.length) return NaN;
            const deg = toNumber(dms[0]);
            const min = toNumber(dms[1]);
            const sec = toNumber(dms[2]);
            if (deg === null || min === null || sec === null) return NaN;
            let val = deg + (min || 0) / 60 + (sec || 0) / 3600;
            if (ref === 'S' || ref === 'W') val = -val;
            return val;
        }

        const lat = dmsToDeg(exifData.GPSLatitude, exifData.GPSLatitudeRef);
        const lng = dmsToDeg(exifData.GPSLongitude, exifData.GPSLongitudeRef);
        return { lat: lat, lng: lng };
    }

    function wgs84togcj02(lng, lat) {
        if (outOfChina(lng, lat)) return [lng, lat];
        let dlat = transformLat(lng - 105.0, lat - 35.0);
        let dlng = transformLng(lng - 105.0, lat - 35.0);
        let radlat = lat / 180.0 * Math.PI;
        let magic = Math.sin(radlat);
        magic = 1 - 0.00669342162296594323 * magic * magic;
        let sqrtMagic = Math.sqrt(magic);
        dlat = (dlat * 180.0) / ((6378245.0 * (1 - 0.00669342162296594323)) / (magic * sqrtMagic) * Math.PI);
        dlng = (dlng * 180.0) / (6378245.0 / sqrtMagic * Math.cos(radlat) * Math.PI);
        let mglat = lat + dlat;
        let mglng = lng + dlng;
        return [mglng, mglat];
    }
    function outOfChina(lng, lat) {
        return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
    }
    function transformLat(x, y) {
        let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
        ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
        ret += (20.0 * Math.sin(y * Math.PI) + 40.0 * Math.sin(y / 3.0 * Math.PI)) * 2.0 / 3.0;
        ret += (160.0 * Math.sin(y / 12.0 * Math.PI) + 320 * Math.sin(y * Math.PI / 30.0)) * 2.0 / 3.0;
        return ret;
    }
    function transformLng(x, y) {
        let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
        ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
        ret += (20.0 * Math.sin(x * Math.PI) + 40.0 * Math.sin(x / 3.0 * Math.PI)) * 2.0 / 3.0;
        ret += (150.0 * Math.sin(x / 12.0 * Math.PI) + 300.0 * Math.sin(x / 30.0 * Math.PI)) * 2.0 / 3.0;
        return ret;
    }

    async function getAddressFromAmap(lng, lat) {
        const key = '6721a02023416bb36161a2eaa735b85a';
        const url = `https://restapi.amap.com/v3/geocode/regeo?key=${key}&location=${lng},${lat}&extensions=all&radius=1000&roadlevel=0`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.status !== '1') throw new Error('高德API错误:' + data.info);
            const regeocode = data.regeocode || {};
            const formatted = regeocode.formatted_address || '未找到地址';
            let poi = '';
            if (regeocode.pois && regeocode.pois.length > 0) {
                poi = regeocode.pois[0].name || '';
            }
            const components = regeocode.addressComponent || null;
            return { formatted, poi, components };
        } catch (err) {
            return { formatted: '地址获取失败', poi: '', components: null };
        }
    }

    function updatePhotoMap(index, lng, lat, title, address) {
        const mapDiv = document.getElementById('photo-map-' + index);
        if (!mapDiv) return;
        if (mapDiv._amap_instance) {
            mapDiv._amap_instance.destroy();
            mapDiv._amap_instance = null;
        }
        const photoMap = new AMap.Map(mapDiv, {
            zoom: 15,
            center: [lng, lat],
            viewMode: '3D',
            resizeEnable: false,
            dragEnable: false,
            doubleClickZoom: false,
            keyboardEnable: false,
            scrollWheel: false
        });
        const marker = new AMap.Marker({
            position: [lng, lat],
            title: title,
            icon: new AMap.Icon({
                image: redStarIcon,
                size: new AMap.Size(32, 32),
                imageSize: new AMap.Size(32, 32)
            }),
            offset: new AMap.Pixel(-16, -32)
        });
        marker.setMap(photoMap);
        if (address && typeof address === 'string' && address !== "正在获取...") {
            marker.setTitle(`${title}\n${address}`);
        } else if (address && address.formatted) {
            marker.setTitle(`${title}\n${address.poi ? address.poi + ' - ' : ''}${address.formatted}`);
        }
        mapDiv._amap_instance = photoMap;
    }

    window.openAllInAmap = function () {
        if (!photosData.length) return;
        let base = 'https://uri.amap.com/marker?';
        let params = photosData.map(d =>
            `position=${d.gpsGCJ02.lng},${d.gpsGCJ02.lat}&name=${encodeURIComponent(d.name)}`
        ).join('&');
        const zoomParam = '&zoom=15';
        const srcParam = '&src=gzcase20190120';
        window.open(base + params + zoomParam + srcParam, '_blank');
    };

    window.copyCoords = function(idx) {
        if (!photosData[idx]) return;
        const d = photosData[idx];
        const coords = `${d.gpsGCJ02.lat.toFixed(8)},${d.gpsGCJ02.lng.toFixed(8)}`;
        navigator.clipboard.writeText(coords).then(() => {
            const resultDiv = document.getElementById('result');
            const msg = document.createElement('div');
            msg.className = 'copy-notice';
            msg.style.color = 'green';
            msg.style.margin = '10px 0';
            msg.textContent = `坐标已复制: ${coords}`;
            resultDiv.prepend(msg);
            setTimeout(() => msg.remove(), 3000);
        }).catch(err => {
            const resultDiv = document.getElementById('result');
            const msg = document.createElement('div');
            msg.className = 'copy-notice';
            msg.style.color = 'red';
            msg.style.margin = '10px 0';
            msg.textContent = '复制失败: ' + err.message;
            resultDiv.prepend(msg);
            setTimeout(() => msg.remove(), 3000);
        });
    };

    window.openInAmapSingle = function(idx) {
        if (!photosData[idx]) return;
        const d = photosData[idx];
        const zoom = 15;
        const src = 'gzcase20190120';
        let url = `https://uri.amap.com/marker?position=${d.gpsGCJ02.lng},${d.gpsGCJ02.lat}&name=${encodeURIComponent(d.name)}&zoom=${zoom}&src=${src}`;
        window.open(url, '_blank');
    };

    let exportBtn = document.getElementById('exportCsvBtn');
    function escapeCsvCell(val) {
        if (val === null || val === undefined) return '';
        const s = String(val);
        if (/[",\n\r]/.test(s)) {
            return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
    }

    function buildCsvFromPhotos(dataList) {
        const headers = ['序号','图片名称','拍摄时间','拍摄地点','原始坐标(WGS84)','转换坐标(GCJ02)','拍摄设备(品牌/型号)'];
        const rows = [headers.map(escapeCsvCell).join(',')];
        dataList.forEach(d => {
            const index = d.index || '';
            const name = d.name || '';
            const shotTime = getDateTimeFromExif(d.exifData) || '';
            const place = (d.address && d.address.formatted) ? (d.address.poi ? (d.address.poi + ' - ' + d.address.formatted) : d.address.formatted) : '';
            const wgs = (d.gpsWGS84 && (typeof d.gpsWGS84.lat === 'number')) ? `${d.gpsWGS84.lat.toFixed(8)},${d.gpsWGS84.lng.toFixed(8)}` : '';
            const gcj = (d.gpsGCJ02 && (typeof d.gpsGCJ02.lat === 'number')) ? `${d.gpsGCJ02.lat.toFixed(8)},${d.gpsGCJ02.lng.toFixed(8)}` : '';
            const device = d.exifData && (d.exifData.Make || d.exifData.Model) ? `${d.exifData.Make || ''} ${d.exifData.Model || ''}`.trim() : '';
            const row = [index, name, shotTime, place, wgs, gcj, device].map(escapeCsvCell).join(',');
            rows.push(row);
        });
        return rows.join('\r\n');
    }

    function triggerDownload(filename, content) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    function attachExportHandler() {
        if (!exportBtn) return;
        exportBtn.addEventListener('click', () => {
            if (!photosData || photosData.length === 0) return;
            const csv = buildCsvFromPhotos(photosData);
            const now = new Date();
            const ts = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            triggerDownload(`photos_export_${ts}.csv`, '\uFEFF' + csv);
        });
    }

    if (exportBtn) {
        attachExportHandler();
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            exportBtn = document.getElementById('exportCsvBtn');
            attachExportHandler();
            try{ updateExportButtonState(); }catch(e){}
        });
    }

    const shareBtn = document.getElementById('shareBtn');
    const shareNotice = document.getElementById('shareNotice');
    const SHARE_URL = 'https://casedate911.github.io';

    function showShareNotice(text, timeout = 3000) {
        if (!shareNotice) return;
        shareNotice.textContent = text;
        shareNotice.style.display = 'block';
        setTimeout(() => { shareNotice.style.display = 'none'; }, timeout);
    }

    async function handleShareClick() {
        try {
            if (navigator.share) {
                await navigator.share({
                    title: document.title || 'CaseDate911',
                    text: '查看并使用该工具：',
                    url: SHARE_URL
                });
                showShareNotice('已通过系统分享面板分享');
                return;
            }
        } catch (err) {
            // 如果 share 抛错，则回退到复制
            console.warn('navigator.share failed:', err);
        }
        // 回退：复制到剪贴板
        if (navigator.clipboard && navigator.clipboard.writeText) {
            try {
                await navigator.clipboard.writeText(SHARE_URL);
                showShareNotice('链接已复制到剪贴板');
                return;
            } catch (err) {
                console.warn('clipboard.writeText failed:', err);
            }
        }
        // 最后退路：使用临时输入元素
        try {
            const ta = document.createElement('textarea');
            ta.value = SHARE_URL;
            ta.style.position = 'fixed'; ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (ok) {
                showShareNotice('链接已复制到剪贴板');
            } else {
                showShareNotice('无法自动复制，请手动复制：' + SHARE_URL);
            }
        } catch (err) {
            showShareNotice('无法复制链接，请手动复制：' + SHARE_URL);
        }
    }

    if (shareBtn) {
        shareBtn.addEventListener('click', handleShareClick);
    }

    function updateExportButtonState() {
        if (!exportBtn) return;
        if (photosData && photosData.length > 0) {
            exportBtn.style.display = 'flex';
            exportBtn.disabled = false;
            if (shareBtn) { shareBtn.style.display = 'flex'; shareBtn.disabled = false; }
        } else {
            exportBtn.style.display = 'none';
            exportBtn.disabled = true;
            if (shareBtn) { shareBtn.style.display = 'none'; shareBtn.disabled = true; }
        }
    }


    

    fileDrop.addEventListener('click', () => updateExportButtonState());
    updateExportButtonState();
    (function(){
        function setupSafeUse(){
            const safeBtn = document.getElementById('safeUseBtn');
            const panel = document.getElementById('safeUsePanel');
            const closeBtn = document.getElementById('safeUseClose');
            const moreBtn = document.getElementById('safeUseMore');
            if(!safeBtn || !panel) return false;
            function openPanel(){ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); safeBtn.setAttribute('aria-expanded','true'); }
            function closePanel(){ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); safeBtn.setAttribute('aria-expanded','false'); }
            safeBtn.addEventListener('click', function(e){ e.stopPropagation(); if(panel.style.display==='block') closePanel(); else openPanel(); });
            panel.addEventListener('click', function(e){ e.stopPropagation(); });
            closeBtn && closeBtn.addEventListener('click', function(e){ e.stopPropagation(); closePanel(); });
            moreBtn && moreBtn.addEventListener('click', function(e){ e.stopPropagation(); window.open('https://www.amap.com/privacy','_blank'); });
            document.addEventListener('click', function(e){ if(panel.style.display==='block'){ const path = e.composedPath ? e.composedPath() : (e.path || []); if(path.indexOf(panel)===-1 && path.indexOf(safeBtn)===-1){ closePanel(); } } });
            document.addEventListener('keydown', function(e){ if(e.key === 'Escape' || e.key === 'Esc'){ if(panel.style.display==='block') closePanel(); } });
            return true;
        }
        if(!setupSafeUse()){
            document.addEventListener('DOMContentLoaded', function(){ setupSafeUse(); });
        }
    })();
    </script>
    <footer>2025@王贵平保留所有权</footer>
</body>
</html>
